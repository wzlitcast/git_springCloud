# 嵌套对象的处理

如果想实现嵌套对象的持久化，而又不借助 JSON 序列化。

同时保证 `,` 号分隔。

应该怎么做呢?

## 类似于表的关系

为了保证 csv 用逗号分隔的统一性，可以新建一个文件。（类似于主从表）

核心对象：

```java
User {
    Address address;
}
```

其中内嵌了一个 address 对象。

如果 User 对象信息存储在 `user.csv` 中。

嵌套的对象可以默认存储在 `user.address.csv` 文件中。

## 对象类型

单个对象：只存储一条

集合/数组：存储多条

Map 对象：暂时不支持。（过于麻烦）

## 如何声明

为了避免无意义的递归处理，可以使用注解 `@Embedded` 显示指定。

这个注解和 `@Csv` 注解可以同时使用吗？

# @Embedded 应该是独立的注解吗？

## 独立

## 不独立

不独立，放在那里？

（1）默认根据类型处理

缺点：不好，无法感知用户意图。

（2）csv 注解添加一个属性

`embedded=false` 是否进行嵌套的处理，默认为 false。

优点：可以感知用户意图

## 独立

全新的一个注解

问题：如何解析？是否会和 csv 注解冲突？

解析方式：

（1）csv 和原来一样，如果同时声明 `@embedded`。则进行相关处理。

（2）会和原来的处理有冲突吗？

也可以没有冲突。

如果是普通的，未声明 embedded，则直接根据 toString();

如果声明了 embedded，则储存信息变为拓展【文件对应的行号】。

注意：不支持多层嵌套，最多一层。（后期再进行拓展处理）

或者支持多级嵌套：

`A.b.c.csv` 这种命名方式。

# 无效的声明

如果指定的属性不是对象，则忽略当前注解 `@embedded`。

# 最终的方案

（1）因为 embedded 和 csv 的解析息息相关。所以直接当做一个属性

（2）默认为 false

（3）只有当指定的属性为对象，或者为对象的集合时，且 embedded=true。才会生效。

## 存储的方式

根据链式调用

存储在 `a.b.csv`

原始文件 `a.csv` 存储 a.b.csv 文件中存储行号。

以后更多层的嵌套，也保持这一规范。

列表多个之间用 `|` 隔开，比如：

`1|2|3`

## slice 方式的存储

如果行数过多，比如 1-10 行。直接存储：

```
1|2|3|4|5|6|7|8|9|10
```

显然有点傻傻的。不如参考 slice 的设计，存储为：

```
1:10
```

当然这样的缺点，引入了新的符号：`:`

为了和原来兼容，可以考虑存储 `1|10` 前面的是开始，后面的是结束。

如果只有一行：直接存储为 `1` 或者 `1|1` 也不影响解析。

## 解析

说好了存储，剩下的就是解析。

解析正常和原来一样。

如果发现一个字段是对象（对象列表）+指定了 embedded=true

则进行相关的关联查看：

（1）文件的路径：当前文件路径+属性.csv 文件

（2）文件对应的行信息：根据存储的内容比如 `1|3` 或者 `2` 直接获取对应文件的内容。

（3）根据获取的文件信息，构建嵌套的对象信息。

# 性能的考虑

如果内容较多，采用 list 行号存储，则性能较差。

可以考虑存储文件的开始/结束位置。

使用 RandomFileAccess 来进行文件的读取。

问题：如果换行？（直接封装在 util 工具类中）

